class FastPaginate{constructor(t){this.url=t.actionUrl,this.key=t.key,this.wrapper=document.querySelector(t.wrapper),this.wrapper&&(this.el={items:this.wrapper.querySelector(".fp-items"),sort:this.wrapper.querySelector(".fp-sort"),formFilters:this.wrapper.querySelector(".fp-filters"),filterInputs:this.wrapper.querySelectorAll(".fp-filters input,select"),filterChange:this.wrapper.querySelector(".fp-filters.fp-filters-change"),loadMore:this.wrapper.querySelector(".fp-loadmore"),pagination:this.wrapper.querySelector(".fp-pagination")},this.path={urlMode:t.url_mode,separator:t.path_separator,page:t.page_name,sort:t.sort_name},this.state={current_page:t.page||1,load_page:t.page||1,total:t.total||0,last_key:t.last_key||0,show:t.show||0,sort:{sortby:t.sortby||"id",sortdir:t.sortdir||"asc"},filters:0<Object.keys(t.filters).length?t.filters:{}},this.class={loading:"fp-loading"},this.addEventListeners(),this.updateLayout(),this.URLManager=new URLManager(this.path.separator))}addEventListeners(){this.el.loadMore?.addEventListener("click",async t=>{t.target.closest(".loadmore-link")&&(t.preventDefault(),this.state.load_page=this.state.current_page+1,t=await this.fetch("loadmore"),await this.response(t))}),this.el.pagination?.addEventListener("click",async t=>{var e=t.target.closest(".pagination-link");if(e)return t.preventDefault(),t.stopPropagation(),t=e.getAttribute("data-page")||e.textContent,this.state.load_page=parseInt(t,10),e=await this.fetch("paginate"),await this.response(e),!1}),this.el.sort?.addEventListener("change",async({target:t})=>{var[t,e]=t.value.split("-"),t=(this.state.sort.sortby=t,this.state.sort.sortdir=e,await this.fetch("sort"));await this.response(t)}),this.el.formFilters&&(this.el.filterChange&&this.el.formFilters.addEventListener("change",async t=>{t.preventDefault();var e,s,t=t.target,a=(this.el.filterInputs?.length&&this.el.filterInputs.forEach(t=>t.disabled=!0),t.name.includes("[min]")||t.name.includes("[max]")?(e=t.name.replace("[min]","").replace("[max]",""),a=this.el.formFilters.querySelector(`[name="${e}[min]"]`),s=this.el.formFilters.querySelector(`[name="${e}[max]"]`),a&&s&&(this.state.filters[e]={min:a.value,max:s.value})):t.name.includes("[]")?(e=t.name.replace("[]",""),a=this.state.filters[e]||[],s=new Set(Array.isArray(a)?a:a.split(",")),t.checked?s.add(t.value):s.delete(t.value),this.state.filters[e]=Array.from(s).sort()):""===t.value&&t.name in this.state.filters?delete this.state.filters[t.name]:this.state.filters[t.name]=t.value,this.state.last_key=0,this.state.current_page=0,this.state.load_page=1,await this.fetch("filters"));await this.response(a)}),this.el.formFilters.addEventListener("submit",t=>{t.preventDefault(),this.submitForm()}),this.el.formFilters.addEventListener("reset",t=>{this.resetForm()}))}updateLayout(){var t;this.el.sort&&(t=this.state.sort.sortby+"-"+this.state.sort.sortdir,t=this.el.sort.querySelector(`[value="${t}"]`))&&(t.selected=!0),this.el.formFilters&&Object.entries(this.state.filters).forEach(([s,e])=>{if("object"==typeof e&&"min"in e&&"max"in e)Object.entries(e).forEach(([t,e])=>{t=this.el.formFilters.querySelector(`[name="${s}[${t}]"]`);t&&(t.value=e)});else{let t=this.el.formFilters.querySelector(`[name="${s}"]`)||this.el.formFilters.querySelector(`[name="${s}[]"]`);if(t)switch(t.type){case"radio":(t=this.el.formFilters.querySelector(`[name="${s}"][value="${e}"]`))&&(t.checked=!0);break;case"checkbox":(e="string"==typeof e?[e]:e).forEach(t=>{t=this.el.formFilters.querySelector(`[name="${s}[]"][value="${t}"]`);t&&(t.checked=!0)});default:t.value=e}}})}async submitForm(){this.state.last_key=0,this.state.current_page=0,this.state.load_page=1,this.URLManager.delete("page");var t=new FormData(this.el.formFilters),t=(this.formDataToObject(t),this.state.filters=this.formDataToObject(new FormData(this.el.formFilters)),await this.fetch("filters"));await this.response(t)}async resetForm(){this.state.last_key=0,this.state.current_page=0,this.state.load_page=1;this.el.formFilters.querySelectorAll("[name]").forEach(t=>{this.URLManager.delete(t.name.replace(/\[\]|\[min\]|\[max\]/g,""))}),this.URLManager.delete("page"),this.state.filters={};var t=await this.fetch("filters");await this.response(t)}formDataToObject(t){let e={};return t.forEach((a,r)=>{let i=r.match(/[^\[\]]+/g);i.reduce((t,e,s)=>(s===i.length-1?r.endsWith("[]")?(t[e]=t[e]||[],t[e].push(a)):Array.isArray(t[e])?t[e].push(a):t[e]=a:t[e]=t[e]||{},t[e]),e)}),e}async fetch(t,e={}){this.updateURL(),this.wrapper.classList.add(this.class.loading);t={action:t,key:this.key,total:this.state.total,current_page:this.state.current_page,load_page:this.state.load_page,last_key:this.state.last_key,sortby:this.state.sort.sortby,sortdir:this.state.sort.sortdir,filters:this.state.filters,...e},e=await fetch(this.url,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)});if(e.ok)return e.json();throw new Error("Failed to fetch data from server")}async response(t){this.wrapper.classList.remove(this.class.loading),this.el.filterInputs?.length&&this.el.filterInputs.forEach(t=>t.disabled=!1),this.state.current_page=t.page||1,this.state.last_key=t?.last_key||"",this.state.total=t.total||0,this.state.show=t.show||0,"loadmore"===t?.action?this.el.items.insertAdjacentHTML("beforeend",t.output||""):this.el.items.innerHTML=t.output||"",this.updatePagination(t),this.updateVariables()}updatePagination(t){this.el.loadMore&&(this.el.loadMore.innerHTML=t?.templates.loadmore||""),this.el.pagination&&(this.el.pagination.innerHTML=t?.templates.pagination||"")}updateVariables(){this.wrapper.querySelectorAll(".fp-total").forEach(t=>{t.innerText=this.state.total.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0,useGrouping:!0}).replace(/,/g," ")})}updateURL(){"get"===this.path.urlMode?Object.entries(this.state).forEach(([t])=>{switch(t){case"load_page":1===this.state.load_page?this.URLManager.delete(this.path.page):this.URLManager.set(this.path.page,this.state.load_page);break;case"sort":this.URLManager.set(this.path.sort,this.state.sort.sortby+"-"+this.state.sort.sortdir);break;case"filters":Object.entries(this.state.filters).forEach(([t,e])=>{if(""===e)this.URLManager.delete(t);else if("string"==typeof e)this.URLManager.set(t,e);else if("object"==typeof e){let s=[],a=",";Object.entries(e).forEach(([t,e])=>{"min"!==t&&"max"!==t||(a="-"),""!==e&&s.push(e)}),""===(e=s.join(a))?this.URLManager.delete(t):this.URLManager.set(t,e)}})}}):(this.URLManager=new URLManager(this.path.separator),Object.entries(this.state).forEach(([t])=>{switch(t){case"load_page":var e=this.path.page+"="+this.state.load_page;1===this.state.load_page?this.URLManager.removePath(e):this.URLManager.addPath(e);break;case"sort":this.URLManager.addPath(`${this.path.sort}=${this.state.sort.sortby}-`+this.state.sort.sortdir);break;case"filters":Object.entries(this.state.filters).forEach(([t,e])=>{if(Array.isArray(e))e=e.join(",");else if("object"==typeof e){let s=[],a=",";Object.entries(e).forEach(([t,e])=>{"min"!==t&&"max"!==t||(a="-"),""!==e&&s.push(e)}),e=s.join(a)}""!==e&&this.URLManager.addPath(t+"="+e)})}})),this.URLManager.updateURL()}}class URLManager{constructor(t=";"){this.url=new URL(window.location.href),this.pathSegments=[],this.pathSeparator=t}has(t){return this.url.searchParams.has(t)}get(t){return this.url.searchParams.get(t)}set(t,e){return this.url.searchParams.set(t,e),this}append(t,e){return this.url.searchParams.append(t,e),this}delete(t){return this.url.searchParams.delete(t),this}addPath(t){return this.pathSegments.includes(t)||(this.pathSegments.push(t),this.updatePath()),this}removePath(e){return this.pathSegments=this.pathSegments.filter(t=>t!==e),this.updatePath(),this}updatePath(){this.url.pathname=`/${this.pathSegments.join(this.pathSeparator)}/`}getURL(){return this.url.toString()}updateURL(){window.history.pushState({},"",this.getURL())}}